# 🎉 xxxbot-pad 自动总结插件 (AutoSummary) 🎉

快速总结文本内容和卡片消息，让你的 xxxbot-pad 瞬间变身效率助手！🚀

<img src="https://github.com/user-attachments/assets/a2627960-69d8-400d-903c-309dbeadf125" width="400" height="600">

## ✍️ 插件描述

`AutoSummary` 是一款为 xxxbot-pad 设计的插件，旨在帮助用户**快速总结**微信聊天中的**文本内容**和**卡片消息**。它能够：

- ✨ **自动提取文本消息中的链接**，并抓取网页内容进行总结。
- 📰 **解析微信卡片消息 (XML 消息)**，例如公众号文章分享等，并进行内容概括。
- 🤖 **集成 Dify API**，利用强大的 AI 能力生成高质量的摘要。
- 🛡️ **支持用户/群组和URL黑白名单**，灵活控制插件处理的范围。
- 🔄 **支持自动总结和手动总结**，满足不同场景的需求。

无论是快速了解群内分享的文章内容，还是概括长篇对话的重点，`AutoSummary` 都能帮你节省宝贵的时间！

## 👨‍💻 作者

- 老夏的金库

## 🌟 插件特性

- **多种内容总结**:
  - **文本消息 📝**: 自动检测文本消息中的 URL 链接，并进行网页内容总结。
  - **卡片消息 📰**: 支持解析和总结微信卡片消息 (XML 格式)，例如微信公众号文章分享、小程序卡片等。
- **强大的 AI 摘要 🧠**: 深度集成 [Dify API](https://dify.ai/)，利用先进的 AI 模型生成精准、简洁的摘要，让您快速抓住重点。
- **灵活的过滤机制 🔗**:
  - **URL白黑名单 🌐**: 控制哪些URL可以被总结，哪些URL不可以被总结。
  - **用户白黑名单 👤**: 控制哪些用户的消息可以被自动总结，哪些不可以。
  - **群组白黑名单 👥**: 控制哪些群组的消息可以被自动总结，哪些不可以。
- **多种总结模式**:
  - **自动总结 🤖**: 根据配置自动总结符合条件的链接和卡片。
  - **手动总结 👆**: 通过发送总结命令手动触发总结。
  - **直接总结URL 🔗**: 通过`{sum_trigger} [URL]`格式直接总结指定URL。
  - **自定义指令总结 🎯**: 通过`{sum_trigger} [自定义指令] [URL]`格式使用自定义指令引导AI总结内容。
  - **追问功能 ❓**: 通过`{qa_trigger} [问题]`格式对已总结内容进行追问，支持有空格和无空格。
- **特殊内容处理 📱**:
  - **微信公众号文章**: 使用特殊方法处理微信公众号文章，提高获取成功率。
  - **小红书笔记**: 针对小红书内容使用特定的总结模板。
  - **GitHub个人主页**: 针对GitHub个人主页使用特定的总结模板。
- **可配置参数 ⚙️**: 通过 `config.toml` 文件，您可以自定义各种参数，满足个性化需求。
- **异步处理 ⏱️**: 采用 `asyncio` 异步框架，保证插件高效运行，不阻塞主程序。
- **详细日志记录 🪵**: 使用 `loguru` 记录详细日志，方便问题排查和插件监控。

## 🛠️ 安装教程

1. **下载插件**：将 `AutoSummary` 插件文件夹放入 XYBotV2 的 `plugins` 目录下。
2. **配置插件**：修改 `plugins/AutoSummary/config.toml` 文件，填入您的 Dify API 相关配置以及其他自定义设置。
3. **替换文件**：替换 xybot.py 到/utils/xybot.py
4. **重启 XYBotV2**：重启您的 XYBotV2 机器人，插件即可生效。

## ⚙️ 配置文件 (config.toml)

您需要在 `plugins/AutoSummary/config.toml` 文件中配置以下参数：

```toml
[AutoSummary]
enable = true

# 总结命令触发词
sum_trigger = "总结"

# 追问命令触发词
qa_trigger = "问"

# 自动总结开关
auto_sum = true

# 用户黑白名单
white_user_list = []  # 私聊白名单，列表中的用户将始终自动总结
black_user_list = []  # 私聊黑名单，列表中的用户将不会自动总结，需要手动触发

# 群组黑白名单
white_group_list = []  # 群聊白名单，列表中的群组将始终自动总结
black_group_list = []  # 群聊黑名单，列表中的群组将不会自动总结，需要手动触发

[AutoSummary.Dify]
enable = true
api-key = "your-api-key"  # 请替换为实际的 API Key
base-url = "http://your-dify-url/v1"  # 请替换为实际的 API URL
http-proxy = ""  # 如果需要代理可以在这里设置

[AutoSummary.Settings]
max_text_length = 8000  # 最大文本长度
expiration_time = 1800  # URL和卡片缓存过期时间（秒），默认30分钟

# URL黑白名单
black_url_list = [  # 黑名单URL
    "https://support.weixin.qq.com",
    "https://channels-aladin.wxqcloud.qq.com"
]
white_url_list = []  # 白名单URL，为空则允许所有非黑名单URL
```

**配置说明:**

- **`[AutoSummary.Dify]`**: Dify API 相关配置。
  - `enable`: **是否启用 Dify 摘要功能**。设置为 `true` 启用，`false` 禁用。禁用后，插件将无法生成摘要。
  - `api-key`: **您的 Dify API Key**。如果您启用了 Dify 摘要功能 (`enable = true`)，则必须填写您的 Dify API Key。
  - `base-url`: **您的 Dify API Base URL**。如果您启用了 Dify 摘要功能 (`enable = true`)，则必须填写您的 Dify API Base URL。
  - `http-proxy`: **HTTP 代理设置 (可选)**。如果您需要通过 HTTP 代理访问 Dify API，请在此处填写代理地址。

- **`[AutoSummary.Settings]`**: 插件通用设置。
  - `max_text_length`: **最大文本长度**。限制发送给 Dify API 进行总结的文本长度。
  - `expiration_time`: **缓存过期时间**。URL、卡片和总结内容的缓存过期时间（秒），默认30分钟。
  - `black_url_list`: **URL 黑名单**。插件将不会总结黑名单列表中的任何链接。
  - `white_url_list`: **URL 白名单**。只有白名单列表中的链接才会被插件总结。如果为空，则不启用白名单。

- **总结命令和自动总结设置**:
  - `sum_trigger`: **总结命令触发词**。用于手动触发总结的命令，默认为"/总结"。
    - 支持多种格式：`{sum_trigger}`、`{sum_trigger} [URL]`、`{sum_trigger} [自定义指令]`、`{sum_trigger} [自定义指令] [URL]`
    - 自定义指令会作为提示词发送给AI，引导AI按照您的需求进行总结
  - `qa_trigger`: **追问命令触发词**。用于对已总结内容进行追问的命令，默认为"问"。
    - 格式：`{qa_trigger} [问题]`，例如：`问这篇文章的主要观点是什么？`
    - 支持触发词和问题之间有不定数量的空格或没有空格
    - 追问功能会使用原始内容重新向AI提问，而不是基于之前的总结
    - 总结内容会在缓存期内保留，可以多次追问
  - `auto_sum`: **自动总结开关**。是否启用自动总结功能，默认为true。
  - `white_user_list`: **用户白名单**。列表中的用户将始终自动总结，即使全局自动总结关闭。
  - `black_user_list`: **用户黑名单**。列表中的用户不会自动总结，需要手动触发。
  - `white_group_list`: **群组白名单**。列表中的群组将始终自动总结，即使全局自动总结关闭。
  - `black_group_list`: **群组黑名单**。列表中的群组不会自动总结，需要手动触发。

## 💡 使用方法

### 自动总结

当配置了自动总结（`auto_sum = true`）时，插件会根据黑白名单规则自动总结链接、文章和卡片：

1. **自动总结规则**：
   - 全局自动总结开关打开且用户/群组不在黑名单中，自动总结
   - 全局自动总结开关关闭但用户/群组在白名单中，自动总结
   - 其他情况不自动总结，需要手动触发

2. **群聊中的用户处理**：
   - 如果群聊中的发送者在用户白名单中，无论群组是否在黑名单中，都会自动总结
   - 如果群组在黑名单中且发送者不在用户白名单中，不会自动总结

### 手动总结

插件支持以下手动总结方式：

1. **直接总结URL**：
   - 格式：`{sum_trigger} [URL]` 或 `{sum_trigger}[URL]`（支持有空格和无空格）
   - 例如：`/总结 https://example.com` 或 `/总结https://example.com`
   - 此格式仅适用于文本URL（以http或https开头），不适用于卡片消息

2. **使用自定义指令总结**：
   - 格式：`{sum_trigger} [自定义指令] [URL]` 或 `{sum_trigger} [自定义指令]`
   - 例如：`/总结 提取文章中的关键技术点 https://example.com` 或 `/总结提取文章中的关键技术点 https://example.com`
   - 支持触发词和自定义指令之间有不定数量的空格或没有空格
   - 自定义指令会作为提示词发送给AI，让AI根据您的具体需求进行总结
   - 自定义指令也可以用于总结最近的链接或卡片，只需发送 `{sum_trigger} [自定义指令]`

3. **总结最近的链接或卡片**：
   - 发送 `{sum_trigger}` 命令（如 `总结`）
   - 插件会总结聊天中最近发送的链接或卡片
   - 如果没有最近的链接或卡片，会提示用户先发送链接或卡片

4. **对总结内容进行追问**：
   - 在总结生成后，可以使用 `{qa_trigger} [问题]` 格式对内容进行追问
   - 例如：`问这篇文章的主要观点是什么？`或`问 这篇文章的主要观点是什么？`
   - 支持触发词和问题之间有不定数量的空格或没有空格
   - 追问功能在缓存期内（默认30分钟）有效，可以多次追问
   - 追问会基于原始内容而不是总结内容，确保回答的准确性

### 消息处理规则

1. **直接发给机器人的消息**：
   - 私聊消息或群聊中@机器人的消息
   - 这类消息中的链接和卡片不会被缓存，除非使用直接总结URL命令
   - 这样可以避免机器人对私聊或@机器人的消息进行不必要的处理

2. **群聊中非@机器人的消息**：
   - 这类消息中的链接和卡片会被缓存，支持手动总结
   - 如果满足自动总结条件，会自动总结


## 🔧 特殊功能

1. **微信公众号文章处理**：
   - 插件使用特殊方法处理微信公众号文章
   - 对微信URL进行完全编码，并添加特殊请求头
   - 提高获取微信文章内容的成功率

2. **多层次内容获取**：
   - 首先尝试使用Jina AI服务获取内容
   - 如果失败，尝试直接获取
   - 如果仍然失败，使用备用方法

3. **智能内容分析**：
   - 自动识别内容类型（如小红书、GitHub个人主页等）
   - 根据内容类型使用不同的提示词模板
   - 生成结构化、详细的内容摘要

## ⚠️ 注意事项

1. **缓存机制**：
   - 链接、卡片信息和总结内容会被缓存一段时间（默认30分钟）
   - 缓存过期后，需要重新发送链接或卡片才能总结，也无法继续追问
   - 可以通过`expiration_time`配置项调整缓存时间
   - 每次追问会刷新缓存时间，延长可追问的时间

2. **URL过滤**：
   - 插件会根据黑白名单过滤URL
   - 如果设置了白名单，只有白名单中的URL才会被处理
   - 黑名单中的URL不会被处理

3. **总结命令**：
   - 可以通过`sum_trigger`配置项自定义总结命令
   - 插件会自动生成相关的衍生触发词，如`{sum_trigger}链接`、`{sum_trigger}内容`等

4. **性能考虑**：
   - 处理大型网页或复杂内容可能需要较长时间
   - 可以通过`max_text_length`配置项限制处理的文本长度

